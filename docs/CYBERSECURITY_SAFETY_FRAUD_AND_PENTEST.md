# CrucibAI — Cybersecurity, Networking, Safety, Fraud Protection & Pentest

**Purpose:** What we do for **our own safety** (platform), how we **help users be safe** (when they build with us or bring existing code), **fraud protection**, and what **must happen now** (pentest, hardening, user-facing security features).

---

## 1. Are we safe? What we do today (platform security)

### 1.1 Network & request layer

| Control | Where | Status |
|--------|--------|--------|
| **Rate limiting** | `RateLimitMiddleware`: 100 req/min per identifier (token or IP) | ✅ Wired |
| **Security headers** | `SecurityHeadersMiddleware`: X-Content-Type-Options, X-Frame-Options, X-XSS-Protection, HSTS, CSP, Referrer-Policy, Permissions-Policy | ✅ Wired |
| **Request validation** | `RequestValidationMiddleware`: max body 100MB; blocks suspicious header patterns (../, &lt;script, javascript:, onerror=, onclick=) | ✅ Wired |
| **CORS** | Starlette CORSMiddleware; configurable origins | ✅ Wired |
| **Request tracking** | Request ID, response time, logging | ✅ Wired |

### 1.2 Authentication & authorization

| Control | Where | Status |
|--------|--------|--------|
| **JWT auth** | Protected routes use `get_current_user`; invalid token → 401 | ✅ Wired |
| **Password hashing** | bcrypt (register/login) | ✅ Wired |
| **No password in responses** | Register/login responses do not return password/hash | ✅ Tested (test_security.py) |
| **MFA** | TOTP available (MFA required flow, verify) | ✅ Wired |
| **API key auth** | Optional Bearer for public API; workspace keys in Settings | ✅ Wired |
| **Scoping** | Projects, agents, runs: ownership by `user_id`; webhook/run-internal use secret/token | ✅ Wired |

### 1.3 Secrets & sensitive data

| Control | Where | Status |
|--------|--------|--------|
| **Webhook secret not in list** | `agents_list` strips `webhook_secret` from trigger_config | ✅ Wired |
| **Stripe webhook** | Signature verified with `STRIPE_WEBHOOK_SECRET`; invalid → 400, no secret leak | ✅ Wired |
| **Agent webhook** | Secret in query/header; invalid → 401 | ✅ Wired |
| **Client error log** | `/errors/log`: message/stack/url truncated and sanitized; no auth; rate-limited | ✅ Wired |
| **Env vars** | JWT_SECRET, Stripe, DB, API keys from env; SecurityAudit checks required vars | ✅ Wired |

### 1.4 Fraud & abuse

| Control | Where | Status |
|--------|--------|--------|
| **Disposable email block** | Register: `_is_disposable_email()` blocks known temp domains (10minutemail, guerrillamail, etc.) | ✅ Wired |
| **Referral caps** | 10 referrals/month per referrer; referrer reward only on free plan; 30-day expiry | ✅ Wired |
| **Credits** | Builds and agent runs deduct credits; 402 when insufficient | ✅ Wired |

### 1.5 Security audit (internal)

| Item | Where | Status |
|------|--------|--------|
| **SecurityAudit class** | `backend/security_audit.py`: env vars, hardcoded secrets scan, auth checks, data protection, API security, infra, compliance, report generation | ✅ Implemented |
| **Run full audit** | `python -m backend.security_audit` → SECURITY_AUDIT_REPORT.md | ✅ Available |

**Summary:** We have rate limiting, security headers, request validation, auth/JWT, secret handling, Stripe/webhook verification, fraud controls (disposable email, referral caps), and an internal security audit module. **We are in a reasonable shape for a SaaS product**; gaps below.

---

## 2. How we help users be safe (when they build with us or bring code)

### 2.1 When they build with us (generated code)

| Feature | Where | What we do |
|---------|--------|------------|
| **Security scan (AI)** | `POST /ai/security-scan` | User sends `files` (path → code); we return a short security checklist (PASS/FAIL) via LLM: e.g. no secrets in client code, auth on API, etc. |
| **Validate-and-fix** | `POST /ai/validate-and-fix` | User sends code + language; we suggest fixes for errors/syntax. |
| **Accessibility check** | `POST /ai/accessibility-check` | User sends code; we return a concise a11y report (labels, contrast, keyboard, ARIA). |
| **Quality score** | `code_quality.py` + build flow | We score frontend/backend/DB/tests (structure, auth hints, validation, etc.); used in orchestration/quality phase. |
| **Security Checker agent** | DAG | Part of the 120-agent swarm; security checklist in build pipeline. |

So: **we help users by (1) scanning their code for security issues (security-scan), (2) checking a11y, (3) validating/fixing code, and (4) baking quality/security into the build.** We do **not** yet run automated SAST/DAST or dependency audits (e.g. npm audit) in the UI; the security scan is LLM-based.

### 2.2 When they bring existing code (import / paste)

- **Same endpoints:** Users can call `POST /ai/security-scan` and `POST /ai/accessibility-check` with **any** code (e.g. pasted or from an existing project). So "bring it here" = paste or upload into Workspace/files, then run security-scan and a11y check.
- **Gap:** We do not have a dedicated "Import existing project → run full security report" one-click flow. Today they use the same AI security-scan and a11y endpoints with that code.

### 2.3 What we should say to users

- **Building with us:** "We run a security checklist on generated code (security scan), accessibility checks, and quality scoring. Use Security scan and Accessibility in the workspace to review before you deploy."
- **Bringing existing code:** "Paste or upload your code and run Security scan and Accessibility check. We’ll give you a short report and recommendations."

**Frontend:** Workspace already calls `POST /ai/security-scan` and `POST /ai/accessibility-check` (e.g. from build/actions or tools). Users can run these on generated or pasted code. A dedicated "Security & safety" line in Learn or Settings can point to these and to the trust page.

---

## 3. What must happen now (steps)

### 3.1 Platform (us) — must-do

| # | Step | Owner | Notes |
|---|------|--------|--------|
| 1 | **External pentest** | Security/ops | Commission a penetration test (web app + API + auth + webhooks). Fix critical/high findings; document and retest. *(Cannot implement in code.)* |
| 2 | **Dependency scanning in CI** | Dev | ✅ Run `npm audit` (frontend) and `pip-audit` (backend) in CI — *enterprise-tests.yml*. |
| 3 | **HTTPS only in production** | Ops | ✅ HSTS in middleware; optional `HTTPS_REDIRECT=1` redirects HTTP→HTTPS. Set in production. |
| 4 | **Secrets scan in CI** | Dev | ✅ gitleaks-action in *enterprise-tests.yml*. |
| 5 | **Run internal SecurityAudit regularly** | Dev/ops | ✅ CI runs `python -m security_audit` in backend. |
| 6 | **CORS in production** | Ops | ✅ Use `CORS_ORIGINS` env; set to frontend URL(s) in production (see RAILWAY_QUICKSTART). |
| 7 | **Rate limit tuning** | Backend | ✅ Stricter limits: register 5/min, login 20/min, checkout 10/min (*middleware.py*). |

### 3.2 User safety (helping users) — must-do

| # | Step | Owner | Notes |
|---|------|--------|--------|
| 8 | **Document security & a11y in UI** | Product/frontend | ✅ Learn panel + Settings (Security tab): "Security & accessibility" + link to /security; Workspace toolbar: Security scan, Accessibility check. |
| 9 | **Optional: dependency audit for projects** | Backend | ✅ `GET /projects/:id/dependency-audit`; optional "Run dependency audit" in AgentMonitor. |
| 10 | **Security scan result in build summary** | Product | ✅ Last security-scan stored on project; badge in AgentMonitor (X PASS, Y FAIL). |

### 3.3 Fraud & abuse — current + optional

| # | Step | Status / Notes |
|---|------|----------------|
| 11 | **Disposable email block** | ✅ Done. |
| 12 | **Referral caps** | ✅ Done. |
| 13 | **Optional: CAPTCHA or bot detection on register** | Consider if signup abuse grows. |
| 14 | **Optional: rate limit per endpoint** | Stricter limits on register, login, password-reset, checkout. |

### 3.4 Compliance & docs

| # | Step | Notes |
|---|------|--------|
| 15 | **Privacy policy & Terms** | Keep published and linked; mention security (e.g. encryption, no selling data). |
| 16 | **Security page or trust center** | One page: "How we keep the platform and your data safe" (auth, encryption, rate limits, no secrets in responses, Stripe for payments, security scan for your code). |
| 17 | **Incident response** | Internal: who to contact, how to escalate, how to notify users if required. |

---

## 4. One-page checklist (what must happen now)

**Platform security (us)**  
- [ ] Commission and complete an **external penetration test**; fix critical/high. *(Ops – cannot implement in code.)*  
- [x] Add **dependency scanning** (npm audit, pip-audit/safety) to CI. *(enterprise-tests.yml)*  
- [x] Enforce **HTTPS only** in production. *(Documented; optional middleware `HTTPS_REDIRECT=1` redirects HTTP→HTTPS.)*  
- [x] Add **secrets scan** in CI (e.g. gitleaks). *(gitleaks-action in enterprise-tests.yml)*  
- [x] Run **SecurityAudit** regularly (e.g. pre-release). *(CI runs `python -m security_audit` in backend.)*  
- [x] Restrict **CORS** to real frontend origin(s) in production. *(Use `CORS_ORIGINS` env; set to frontend URL in prod.)*  
- [x] Review **rate limits** for auth/payment. *(Stricter limits on register, login, checkout.)*

**User safety (helping users)**  
- [x] Add **Security & accessibility** in-product (short doc + run Security scan / A11y). *(Learn panel + link to /security.)*  
- [x] Optionally show **security-scan summary** in build/AgentMonitor. *(Last scan stored on project; badge in AgentMonitor.)*  
- [x] Optionally add **dependency audit** for user projects (npm/pip). *(GET /projects/:id/dependency-audit; optional UI.)*

**Fraud**  
- [x] Disposable email block.  
- [x] Referral caps.  
- [ ] Optional: CAPTCHA/bot detection, stricter auth endpoints.

**Compliance & communication**  
- [x] **Security/trust page**: "How we keep the platform and your code safe." *(/security – Security.jsx.)*  
- [x] **Incident response** plan and ownership. *(docs/INCIDENT_RESPONSE.md.)*

---

## 4b. How we get users to bring their code (transfer, fix, continue, rebuild)

**Answer (short):** We get users to bring code by supporting **paste**, **ZIP upload**, and **Git URL** in an **Import** flow (Dashboard → "Import project"). After import we **stand up** the project in our Workspace (files loaded from project workspace). We **understand** it via optional "Understand this project" summary and by running **Security scan** and **Accessibility check** on the same code. We **give feedback** in the scan/a11y reports and in the Workspace. Users can **fix** (Validate-and-fix, chat), **improve** (chat), **continue** (edit and build in the same project), or **rebuild from start** (new project with their permission). We receive code from local (paste/ZIP), Git, or other builders (ZIP export); we are ready to receive, review, edit, fix, improve, navigate, and understand. Full product spec: **docs/BRING_CODE_TRANSFER_AND_CONTINUE.md**.

---

## 5. Summary

- **Are we safe?** We have solid basics: rate limiting (global + stricter for auth/payment), security headers, auth, secret handling, webhook verification, fraud controls, HTTPS redirect (env), and an internal security audit. We are **not** fully "pentest-ready" until an **external pentest** is done and findings are closed.
- **Can we help users be safe?** Yes: **security-scan** and **accessibility-check** on any code (built with us or brought in), surfaced in Learn, Workspace, and AgentMonitor (security-scan badge). Optional **dependency audit** (npm/pip) per project in AgentMonitor.
- **What is implemented:** CI (dependency + secrets scan, SecurityAudit); production guidance (CORS_ORIGINS, HTTPS_REDIRECT in RAILWAY_QUICKSTART); Security/trust page and incident response doc; in-product Security & accessibility (Learn + link to /security); security-scan result stored on project and shown in AgentMonitor; optional dependency audit endpoint and UI. **Remaining (ops):** Commission external pentest; set CORS_ORIGINS and HTTPS_REDIRECT in production.

This document is the single place for cybersecurity, networking, safety, fraud, and pentest for CrucibAI.
